<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    * {
      font-family: 'SanSerif', sans-serif;
      margin: 0;
      padding: 0;
    }
    header{
      margin: 1em 0;
      display: flex;
      justify-content: center;
      gap: 1em;
    }
    header button {
      font-size: large;
    }
    main {
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }

    article {
      padding: 1em;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 10px;
      overflow: hidden;
      transition: transform 0.3s ease-in-out;
      width: 300px;
    }

    article:hover {
      transform: scale(1.05);
    }

    img {
      width: 100%;
      height: auto;
      border-bottom: 1px solid #ddd;
    }

    h2 {
      font-size: 1.5em;
      margin: 10px;
    }

    p {
      color: #666;
      font-size: 1em;
      margin: 10px;
    }
    button{
      cursor: pointer;
      background-color: rgb(248, 89, 232);
      border-radius: 10px;
      padding: 4px 15px;
      border: none;
      font-weight: 400;
    }
    button:hover{
      background-color: rgba(248, 89, 232, 0.885);
    }
    input, select{
      /* background-color: rgb(248, 89, 232); */
      border-radius: 10px;
      padding: 4px 15px;
      border: none;
      font-weight: 400;
    }


    .container-btns{
      display: flex;
      justify-content: space-evenly;
    }

    h1{
      text-align: center;
    }

    form{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: .5em;
    }
    section input{
    width: 30vw;
    }
    section div{
      display: flex;
      justify-content: space-around;
      gap: .5em;
    }
    .btn-create{
      font-weight: bolder;
      background-color: rgb(18, 206, 206);
    }
    .btn-create:hover{
      background-color: rgba(112, 233, 233, 0.829);
    }
    .btn-update{
      background-color: rgb(246, 224, 60);
    }
    .btn-update:hover{
      background-color: rgb(254, 195, 0);
    }
    .btn-delete{
      background-color: rgb(209, 63, 97);
    }
    .btn-delete:hover{
      background-color:rgb(202, 7, 52);
    }
    .cancel-search {
      background-color: rgb(209, 63, 97);
      color: #fff;
    }
    .cancel-search:hover {
      background-color:rgb(251, 2, 60);
      color: #fff;
    }
    @media (prefers-color-scheme: dark) {
    body {
      background-color: #1c1b1b;
      color: #ffffff;
    }
    .container-error{
      background-color: red;
      border-radius: 10px;
      left: 50%;
      transform: translateX(-50%);
      position: absolute;
      padding: .3em .6em;
      color: #1c1b1b;
      font-weight: 5  00;
      text-align: center;
      display: none;
    }
  }
  
  </style>
  <script type="module">
    const container = document.getElementsByTagName('main')
    const selectForm = document.getElementById('form-search')
    const btnCancelSearch = document.querySelector('.cancel-search')
    const inputSearch = document.getElementById('input-search')
    const select = document.querySelector('#genres')

    function fnDebounce (fn, delay = 200) { 
      let timeout               
      return function () {      
        const self = this
        const arg = arguments
        clearTimeout(timeout)

        return new Promise((resolve) => {
          timeout = setTimeout(async() => {
            const result = await fn.apply(self, arg)
            resolve(result)
          }, delay)
        })
      }
    }

    inputSearch.addEventListener('input', async(e) => {
      const value = e.target.value
      const movies = await fetchMoviesDebouced({search: value})
      if (movies?.error) {     
        showMovies({movies: []})        
      } else {
        showMovies({movies})        
      }
    })

    btnCancelSearch.addEventListener('click', async(e) => {
      if( !select.value && !inputSearch.value ) return

      select.value = ''
      inputSearch.value = ''
      const valueSelect = select.value
      const valueinput = inputSearch.value
      const movies = await fetchMovies({search: ''})
      if (movies?.error) {      
        showMovies({movies: []})        
      } else {
        showMovies({movies})        
      }
    })

    let beforeSearh = ''
    selectForm.addEventListener('submit', async(e) => {
      e.preventDefault();
      const valueinput = inputSearch.value
      
      const form = new FormData(e.target)
      const { query } = Object.fromEntries(form)      
      if ((!valueinput) || beforeSearh === query  ) return
      beforeSearh = query
      const movies = await fetchMovies({search: query})
      if (movies?.error) {      
        showMovies({movies: []})
        
      } else {
        showMovies({movies})        
      }
    })

    select.addEventListener('change', async(e) => {
      const value = select.value;
      const movies = await fetchMovies({gender:value})
      if (movies?.error) {      
        showMovies({movies: []})
        
      } else {
        showMovies({movies})        
      }
      
      console.log(value);      
    })

    const fetchGenders = async() => {
    try {      
      const responseJson = await fetch('http://localhost:4000/genders')
      const genders = await responseJson.json()      
      return genders
    } catch (error) { 
      const ce = document.querySelector('.container-error')
      ce.style.display = 'block'

      ce.innerHTML = 'Sorry, in this moment something is bad'
    }}

    const showGenders = ({genders}) => {
      genders.forEach(gender => {          
        const option = document.createElement('option')
        option.value = gender.name
        option.innerText = gender.name
        select.appendChild(option)
      })
    }
    fetchGenders().then(genders => showGenders({genders}))

    const fetchMovies = async({gender = '', search = ''}) => {
      try {      
        const responseJson = await fetch(`http://localhost:4000/movies?gender=${gender}&search=${search}`)
        const movies = await responseJson.json()      
        return movies
      } catch (error) {
        const ce = document.querySelector('.container-error')
      ce.style.display = 'block'

      ce.innerHTML = 'Sorry, in this moment something is bad'
      }
    }

    const showMovies = ({movies}) => {
      if (!movies.length) {
        container[0].innerHTML = ''
        const span = document.createElement('span')
        span.innerText = 'There aren\'t movies'
        container[0].append(span)
        return
      }
      container[0].innerHTML = '' 
      const fragment = document.createDocumentFragment()
      movies.forEach(movie => {        
        const article = document.createElement('article')
        const title = document.createElement('h2')
        const descripotion = document.createElement('p')
        const img = document.createElement('img')
        const containerButtons = document.createElement('div')
        const buttonUpdate= document.createElement('button')
        const buttonDelete = document.createElement('button')

        img.src = movie.poster
        title.innerText = movie.title
        descripotion.innerText = `${movie.director} ${movie.genre} , ${movie.year}`
        containerButtons.className = 'container-btns'
        buttonDelete.className = 'btn-delete'
        buttonUpdate.className = 'btn-update'
        buttonDelete.innerText = 'Delete'
        buttonUpdate.innerText = 'Update'

        buttonDelete.addEventListener('click', (e) => {
          fetch('http://localhost:4000/movies/'+movie.id, {
            method: "DELETE",
          })
          .then(res => {
            if(res.ok) article.remove()
          })         
      })
        containerButtons.append(buttonUpdate, buttonDelete)
        article.append(title, img, descripotion, containerButtons)
        fragment.appendChild(article)
      });
      container[0].appendChild(fragment)
    }

    fetchMovies({}).then(movies => showMovies({movies}))

    const fetchMoviesDebouced = fnDebounce( fetchMovies , 400)

  </script>
</head>
<body>
  <div class="container-error">        
  </div>
  <header class="">
    <h1>Movies Management </h1>
    <button class="btn-create" title="create movie">+</button>
  </header>
  

  <section>
    <form action="" id="form-search">
      <section>
        <input id="input-search" name="query" type="text" placeholder="Search: The Matrix, Leonidas,Titanic...">
        <button class="cancel-search" type="button">X</button>
      </section>
      <div>
        <label for="genre">Searh by Genre</label> <br>
        <select name="genre" id="genres">
          <option selected value="">Selecciona un genero</option>    
        </select>
        <button>Search By</button>
      </div> 
    </form> 
  </section>
  <main></main>
</body>
</html>